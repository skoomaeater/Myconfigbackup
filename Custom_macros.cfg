[gcode_macro COLD_PULL]
gcode:
    # Set the hotend to 200C and wait for it to reach temp
    M109 S200

    # Retract slightly to release pressure and set new target temp
    G91
    G1 E-10 F1200
    M104 S75

    # Extrude very slowly (5mm over 1 minute) while cooling
    G1 E5 F5

    # Wait for the hotend to cool to 75C and hold that temp
    M109 S75

    # Beep and display a message to get your attention
    M300 P500 ; Beep for half a second
    M117 Filament is at pull temp.

    # Heat hotend back up (no wait) and wait for 30 seconds to pull
    M104 S200
    G4 P30000 ; Dwell for 30 seconds
    M117 Ready to print!

    # Cool down the hotend for safety
    M104 S0

[gcode_macro PURGE]
description: Purge a specified amount of filament
gcode:
  {% set EXTRUDE = params.E|default(100)|float %}
  M109 S{printer.extruder.target}
  RESPOND TYPE=command MSG="Purging {EXTRUDE}mm of filament..."
  G91
  G1 E{EXTRUDE} F300
  G90
  M400

[gcode_macro M600.1]
description: Filament Change without menus
gcode:
  {% if printer.toolhead.is_printing %}
    # Behavior when a print is active
    RESPOND TYPE=command MSG="Pausing print for filament change."
    PAUSE

    # Move to a safe location
    G91
    G1 Z50 F1000
    G90
    G1 X10 Y10 F6000
    
    # Unload filament and wait for new filament
    _UNLOAD_FILAMENT
    M117 Insert new filament and wait for detection.
    
    # Wait for the filament sensor to detect a new filament
    # Note: Klipper does not support native while loops,
    # so we will rely on a pause for user interaction.
    M117 Waiting for filament insertion...

    # Wait 15 seconds after purging
    PURGE E150
    G4 P15000

    # Resume the print
    RESPOND TYPE=command MSG="Resuming print."
    RESUME

  {% else %}
    # Behavior when the printer is idle
    RESPOND TYPE=command MSG="Preparing for filament change."

    # Heat up nozzle to a safe temperature
    M109 S200

    # Unload filament
    _UNLOAD_FILAMENT
    
    # Wait for new filament insertion
    M117 Insert new filament and wait for detection.
    
    PURGE_100

  {% endif %}
